<!DOCTYPE html>
<!-- James Tauber's Candelabra v0.2 / https://github.com/jtauber/candelabra -->
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>candelabra</title>
        <meta name="viewport" content="width=device-width, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <link rel="apple-touch-icon" href="icon.png" />
        <link rel="apple-touch-startup-image" href="splash.png" />
        <style>
            html, body {
                height: 100%;
            }
            table, tr, td {
                margin: 0;
                padding: 0;
                border: 0;
                outline: 0;
                font-size: 100%;
                vertical-align: baseline;
                background: transparent;
            }
            body {
                margin: 0;
                font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
                font-size: 13px;
                line-height: 18px;
                color: #333;
            }
            .pull-left {
                float: left;
            }
            .pull-right {
                float: right;
            }
            .row::before, .row::after {
                display: table;
                content: "";
            }
            .row::after {
                clear: both;
            }
            ul.unstyled {
                list-style: none;
                padding: 0;
            }
            .row {
                clear: both;
                margin-left: 0;
            }
            .holder {
                min-height: 100%;
                background-color: #333;
                -webkit-box-shadow: inset 0px 0px 40px 5px rgba(0, 0, 0, 0.5);
                -moz-box-shadow: inset 0px 0px 40px 5px rgba(0, 0, 0, 0.5);
                box-shadow: inset 0px 0px 40px 5px rgba(0, 0, 0, 0.5);
            }
            .projects {
                padding-bottom: 40px;
            }
            .project {
                padding: 5px 10px;
                border-top: 1px solid #EEE;
                background: #DDD;
                border-bottom: 1px solid #BBB;
                color: #999;
                background-color: #fafafa;
                background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), color-stop(25%, #ffffff), to(#e6e6e6));
                background-image: -webkit-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: -moz-linear-gradient(top, #ffffff, #ffffff 25%, #e6e6e6);
                background-image: -ms-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: -o-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-repeat: no-repeat;
                filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#e6e6e6', GradientType=0);
            }
            .project:last-child {
                -webkit-box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.5);
                -moz-box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.5);
                box-shadow: 0px 10px 10px 0px rgba(0, 0, 0, 0.5);
            }
            .project-header {
                font-size: 1.5em;
                line-height: 1.5em;
            }
            .project.active .project-header {
                color: #000;
                font-weight: bold;
            }
            .project-header .timer:hover {
                cursor: pointer;
            }
            .project-name:hover {
                cursor: pointer;
            }
            .project-times {
                display: none;
            }
            .project-times ul {
                margin: 5px 0 0;
            }
            .project-times li {
                font-size: 9pt;
                margin-bottom: 3px;
                padding: 3px 6px;
                background: #DDD;
                color: #666;
                -webkit-box-shadow: inset 0px 2px 2px 1px rgba(0, 0, 0, 0.2);
                -moz-box-shadow: inset 0px 2px 2px 1px rgba(0, 0, 0, 0.2);
                box-shadow: inset 0px 2px 2px 1px rgba(0, 0, 0, 0.2);
            }
            .project .project-name:before {
                content: "\25B8 \A0";
            }
            .project.open .project-times {
                display: block;
            }
            .project.open .project-name:before {
                content: "\25BE \A0";
            }
            .bottom-bar {
                background: #EEE;
                padding: 5px 0px;
                position: fixed;
                bottom: 0;
                width: 100%;
                -webkit-box-shadow: 0px -10px 10px 0px rgba(0, 0, 0, 0.5);
                -moz-box-shadow: 0px -10px 10px 0px rgba(0, 0, 0, 0.5);
                box-shadow: 0px -10px 10px 0px rgba(0, 0, 0, 0.5);
            }
            .bottom-bar table {
                width: 100%
            }
            .bottom-bar table td {
                padding: 0 10px;
            }
            .bottom-bar table td.add-button-column {
                width: 90px;
            }
            .bottom-bar form {
                margin: 0 5px;
            }
            .bottom-bar input[type=text] {
                width: 100%;
                height: 18px;
                padding: 4px;
                font-size: 13px;
                line-height: 18px;
                color: #555;
                border: 1px solid #CCC;
                -webkit-border-radius: 3px;
                -moz-border-radius: 3px;
                border-radius: 3px;
            }
            .btn {
                display: inline-block;
                padding: 4px 10px 4px;
                font-size: 13px;
                line-height: 18px;
                color: #333333;
                text-align: center;
                text-shadow: 0 1px 1px rgba(255, 255, 255, 0.75);
                background-color: #fafafa;
                background-image: -webkit-gradient(linear, 0 0, 0 100%, from(#ffffff), color-stop(25%, #ffffff), to(#e6e6e6));
                background-image: -webkit-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: -moz-linear-gradient(top, #ffffff, #ffffff 25%, #e6e6e6);
                background-image: -ms-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: -o-linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-image: linear-gradient(#ffffff, #ffffff 25%, #e6e6e6);
                background-repeat: no-repeat;
                filter: progid:DXImageTransform.Microsoft.gradient(startColorstr='#ffffff', endColorstr='#e6e6e6', GradientType=0);
                border: 1px solid #ccc;
                border-bottom-color: #bbb;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
                -webkit-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
                -moz-box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
                box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.2), 0 1px 2px rgba(0, 0, 0, 0.05);
                cursor: pointer;
                *margin-left: .3em;
            }
            .btn:hover {
                color: #333333;
                text-decoration: none;
                background-color: #e6e6e6;
                background-position: 0 -15px;
                -webkit-transition: background-position 0.1s linear;
                -moz-transition: background-position 0.1s linear;
                -ms-transition: background-position 0.1s linear;
                -o-transition: background-position 0.1s linear;
                transition: background-position 0.1s linear;
            }
            .btn:focus {
              outline: thin dotted;
              outline: 5px auto -webkit-focus-ring-color;
              outline-offset: -2px;
            }
            .btn.active, .btn:active {
              background-image: none;
              -webkit-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
              -moz-box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
              box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15), 0 1px 2px rgba(0, 0, 0, 0.05);
              background-color: #e6e6e6;
              background-color: #d9d9d9 \9;
              color: rgba(0, 0, 0, 0.5);
              outline: 0;
            }
            .bottom-bar button {
                width: 100%;
            }
            .clear-times, .delete-project {
                cursor: pointer;
                float: right;
            }
            .separator {
                float: right;
            }
            .clear-times:hover {
                color: #666;
            }
            .delete-project:hover {
                color: #C33;
            }
        </style>
    </head>
    <body>
        <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.12.0/react.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/react/0.12.0/JSXTransformer.js"></script>
        <script>
            Array.prototype.getIndexBy = function (name, value) {
                for (var i = 0; i < this.length; i++) {
                    if (this[i][name] == value) {
                        return i;
                    }
                }
            }
            var guid = (function() {
              function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                           .toString(16)
                           .substring(1);
              }
              return function() {
                return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                       s4() + '-' + s4() + s4() + s4();
              };
            })();
        </script>
        <script type="text/jsx">
            /** @jsx React.DOM */
            var AddProjectForm = React.createClass({
                handleSubmit: function (e) {
                    e.preventDefault();
                    var name = this.refs.projectName.getDOMNode().value.trim();
                    if (!name) return;
                    this.props.onProjectSubmit(name);
                    this.refs.projectName.getDOMNode().value = "";
                    return;
                },
                render: function () {
                    return (
                        <form className="bottom-bar" onSubmit={this.handleSubmit}>
                            <table>
                                <tr>
                                    <td className="project-name-column">
                                        <input id="add-project-name" type="text" ref="projectName" />
                                    </td>
                                    <td className="add-button-column">
                                        <button id="add-project-button" className="btn">+ Project</button>
                                    </td>
                                </tr>
                            </table>
                        </form>
                    );
                }
            });
            var ProjectTimer = React.createClass({
                /*
                 * The ProjectTimer calculates total time based on the series
                 * of time entries.
                 *
                 * [{start: "01:15", end: "03:15"}] === "02:00"
                 * [{start: "01:15", end: "03:15"}, {start: "04:00", end: "05:00"}] === "03:00"
                 * [{start: "01:15", end: null}] === calculated time since "01:15"
                 * [] === "00:00"
                 *
                 * NOTE: these are display values, the underlying data are js Date() objects
                 */
                getInitialState: function () {
                    return {now: new Date()};
                },
                componentDidMount: function() {
                    var timer = this;
                    setInterval(function() {timer.setState({now: new Date()})}, 10000);
                },
                formatMilliseconds: function(msecs) {
                    var s = Math.round(msecs / 1000),
                        m = Math.floor(s / 60),
                        h = Math.floor(m / 60),
                        mm = m % 60;
                    if (mm < 10) {
                        mm = "0" + mm;
                    }
                    if (h < 10) {
                        h = "0" + h;
                    }
                    return h + ":" + mm;
                },
                displayTime: function (times) {
                    var msecs = 0,
                        now = this.state.now;
                    times.forEach(function (time) {
                        var start = new Date(time.start),
                            end = new Date(time.end);
                        if (!time.end) {
                            end = now;
                        }
                        msecs += end - start;
                    });
                    return this.formatMilliseconds(msecs);
                },
                handleClick: function (e) {
                    this.props.onTimerClicked()
                },
                render: function () {
                    return (
                        <div className="pull-right timer" onClick={this.handleClick}>
                            {this.displayTime(this.props.project.times)}
                        </div>
                    );
                }
            });
            var TimeEntry = React.createClass({
                displayEntry: function (entry) {
                    var start = new Date(entry.start);
                    if (!entry.end) {
                        return start + " – ";
                    }
                    return start + " – " + new Date(entry.end);
                },
                render: function () {
                    return (
                        <li>{this.displayEntry(this.props.entry)}</li>
                    );
                }
            });
            var Project = React.createClass({
                getInitialState: function () {
                    return {open: false};
                },
                handleProjectNameClick: function () {
                    this.setState({open: !this.state.open});
                },
                handleDeleteProject: function(e) {
                    this.props.onDeleteProject(this.props.project);
                },
                handleClearTimes: function (e) {
                    this.props.onClearTimes(this.props.project);
                },
                handleTimerClicked: function (e) {
                    this.props.onTimerClicked(this.props.project);
                },
                projectClasses: function () {
                    var activePredicate = function (time) {return time.end === null;},
                        active = this.props.project.times.some(activePredicate),
                        classes = this.state.open ? "project open" : "project";
                    classes += active ? " active" : "";
                    return classes
                },
                render: function () {
                    var entries = [];
                    this.props.project.times.forEach(function (entry) {
                        entries.push(<TimeEntry entry={entry} />)
                    });
                    return (
                        <div className={this.projectClasses()}>
                            <div className="project-header row">
                                <div className="pull-left project-name" onClick={this.handleProjectNameClick}>
                                    {this.props.project.name}
                                </div>
                                <ProjectTimer project={this.props.project} onTimerClicked={this.handleTimerClicked} />
                            </div>
                            <div className="project-times row">
                                <ul className="unstyled">
                                    {entries}
                                </ul>
                                <span className="delete-project" onClick={this.handleDeleteProject}>delete project</span>
                                <span className="separator">&nbsp;&bull;&nbsp;</span>
                                <span className="clear-times" onClick={this.handleClearTimes}>clear times</span>
                            </div>
                        </div>
                    );
                }
            });
            var Candelabra = React.createClass({
                storageKey: "candelabra-data",
                componentWillMount: function () {
                    var data = loadData("candelabra-data") || this.state;
                    if (data) {
                        this.setState(data);
                    }
                },
                componentDidUpdate: function (prevProps, prevState) {
                    setData(this.storageKey, this.state);
                },
                handleProjectSubmit: function (projectName) {
                    var data = loadData(this.storageKey);
                    data.projects.push({id: guid(), name: projectName, times: []});
                    this.setState(data);
                },
                handleDeleteProject: function (project) {
                    var data = loadData(this.storageKey);
                    data.projects.splice(data.projects.getIndexBy("id", project.id), 1);
                    this.setState(data);
                },
                handleClearTimes: function (project) {
                    var data = loadData(this.storageKey);
                    data.projects[data.projects.getIndexBy("id", project.id)].times = [];
                    this.setState(data);
                },
                handleTimerClicked: function (project) {
                    /*
                     * Clicking on timer should:
                     * 1. If it's active (has an end that is null), then set it to current time
                     * 2. If it's inactive (has no times, or most recent end is not null):
                     *    a. then add a new time entry with start as current time and end as null
                     *    b. find any other project that might be active and mark it inactive by
                     *       timestampping it's last end
                     */
                    var activePredicate = function (time) {return time.end === null;},
                        data = loadData(this.storageKey),
                        active = project.times.some(activePredicate),
                        stamp = (new Date()).valueOf(),
                        entry = project.times[project.times.getIndexBy("end", null)];
                    if (active) {
                        entry.end = stamp;
                    } else {
                        project.times.push({start: stamp, end: null});
                        data.projects.forEach(function (p) {
                            if (p.id !== project.id) {
                                var active = p.times.some(activePredicate),
                                    entry = p.times[p.times.getIndexBy("end", null)];
                                if (active) {
                                    entry.end = stamp;
                                }
                            }
                        });
                    }
                    data.projects[data.projects.getIndexBy("id", project.id)] = project;
                    this.setState(data);
                },
                render: function () {
                    var projects = [],
                        handleClearTimes = this.handleClearTimes,
                        handleDeleteProject = this.handleDeleteProject,
                        handleTimerClicked = this.handleTimerClicked;
                    this.state.projects.forEach(function (project) {
                        projects.push(
                            <Project project={project}
                                     onClearTimes={handleClearTimes}
                                     onDeleteProject={handleDeleteProject}
                                     onTimerClicked={handleTimerClicked} />
                        )
                    });
                    return (
                        <div className="holder">
                            <div className="projects">
                                {projects}
                            </div>
                            <AddProjectForm onProjectSubmit={this.handleProjectSubmit} />
                        </div>
                    );
                }
            });

            var loadData = function (key) {
                var state = localStorage.getItem(key);
                if (state) {
                    try {
                        return JSON.parse(state);
                    } catch (e) {
                        if (console) {
                            console.warn("Unable to load state from localStorage: ", state);
                        }
                    }
                }
                return {projects: []};
            };
            var setData = function (key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            };

            React.render(<Candelabra />, document.body);
        </script>
    </body>
</html>
